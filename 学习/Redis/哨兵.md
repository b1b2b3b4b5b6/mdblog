# 哨兵

## 作用
* `监控`：不断检查主服务器和从服务器是否正常运行。
* `通知`：当被监控的某个redis服务器出现问题，Sentinel通过API脚本向管理员或者其他应用程序发出通知。
* `自动故障转移`：当主节点不能正常工作时，Sentinel会开始一次自动的故障转移操作，它会将与失效主节点是主从关系的其中一个从节点升级为新的主节点，并且将其他的从节点指向新的主节点，这样人工干预就可以免了。
* `配置提供者`：在Redis Sentinel模式下，客户端应用在初始化时连接的是Sentinel节点集合，从中获取主节点的信息。

## 原理
![](https://raw.githubusercontent.com/b1b2b3b4b5b6/pic/main/PicGo/202210241119072.png)
### 1
![](https://raw.githubusercontent.com/b1b2b3b4b5b6/pic/main/PicGo/202210241120146.png)
> 每个Sentinel节点都需要定期执行以下任务：每个Sentinel以每秒一次的频率，向它所知的主服务器、从服务器以及其他的Sentinel实例发送一个PING命令。

### 2
![](https://raw.githubusercontent.com/b1b2b3b4b5b6/pic/main/PicGo/202210241120749.png)
> 如果一个实例距离最后一次有效回复PING命令的时间超过down-after-milliseconds所指定的值，那么这个实例会被Sentinel标记为主观下线

### 3
 ![](https://raw.githubusercontent.com/b1b2b3b4b5b6/pic/main/PicGo/202210241120704.png)
> 如果一个主服务器被标记为主观下线，那么正在监视这个服务器的所有Sentinel节点，要以每秒一次的频率确认主服务器的确进入了主观下线状态

### 4
 ![](https://raw.githubusercontent.com/b1b2b3b4b5b6/pic/main/PicGo/202210241121267.png)
> 如果一个主服务器被标记为主观下线，并且有足够数量的Sentinel（至少要达到配置文件指定的数量）在指定的时间范围内同意这一判断，那么这个主服务器被标记为客观下线

### 5
![](https://raw.githubusercontent.com/b1b2b3b4b5b6/pic/main/PicGo/202210241121438.png)
> 一般情况下，每个Sentinel会以每10秒一次的频率向它已知的所有主服务器和从服务器发送INFO命令，当一个主服务器被标记为客观下线时，Sentinel向下线主服务器的所有从服务器发送INFO命令的频率，会从10秒一次改为每秒一次

### 6
 ![](https://raw.githubusercontent.com/b1b2b3b4b5b6/pic/main/PicGo/202210241121022.png)
> * 7、当没有足够数量的Sentinel同意主服务器下线时，主服务器的客观下线状态就会被移除
> * 当主服务器重新向Sentinel的PING命令返回有效回复时，主服务器的主观下线状态就会被移除。