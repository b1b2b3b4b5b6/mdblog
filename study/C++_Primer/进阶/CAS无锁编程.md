# CASæ— é”ç¼–ç¨‹

### CASï¼ˆVï¼ŒEï¼ŒNï¼‰

* `V`:å†…å­˜å€¼ï¼ˆå…±äº«å˜é‡ï¼‰
* `E`:æ—§çš„é¢„æœŸå€¼ï¼ˆå·¥ä½œå†…å­˜çš„å€¼ï¼‰
* `N`:è¦ä¿®æ”¹çš„æ–°å€¼ï¼ˆä¿®æ”¹å…±äº«å˜é‡çš„å€¼ï¼‰

å½“ä¸”ä»…å½“`é¢„æœŸå€¼E`==`å†…å­˜å€¼V`ç›¸ï¼Œå°†`å†…å­˜å€¼V`=`N`ï¼Œå¦åˆ™ä»€ä¹ˆéƒ½ä¸åšã€‚

### ç‰¹æ€§
* é€šè¿‡ç¡¬ä»¶æŒ‡ä»¤å®ç°ï¼Œå…·æœ‰`åŸå­æ€§`

### å‡½æ•°
```cpp
class atomic {
    bool compare_exchange_strong(T& expect /*ç”¨æ¥æ¯”è¾ƒçš„å€¼*/, T desired/*ç”¨æ¥è®¾ç½®çš„å€¼*/)
    bool compare_exchange_weak(T& expect, T desired)
}

```
æ‰€ä»¥weakå’Œstrongçš„åŒºåˆ«åœ¨äºï¼Œweakä»ç„¶åœ¨`*ptr == expected`çš„æ—¶å€™ï¼Œæ‰§è¡Œä¾ç„¶ä¼šæœ‰å°æ¦‚ç‡å¤±è´¥ä¹Ÿå°±æ˜¯è¯´ï¼Œ å³ä½¿`*ptr == expected`ï¼Œæ­¤æ—¶ä¹Ÿä¸ä¼šå‘ç”Ÿå€¼çš„è®¾ç½®ï¼Œè¿”å›falseã€‚ï¼ˆä¸ä¼šæ˜¯è®¾ç½®æˆåŠŸäº†ï¼Œä½†æ˜¯è¿”å›çš„æ˜¯falseï¼‰

### ä¼ªä»£ç 
```C++
if (target == expected) {  // æ¯”è¾ƒ
    target = desired;     // æˆåŠŸï¼šäº¤æ¢
    return true;
} else {
    expected = target;     // å¤±è´¥ï¼šæ›´æ–°old_vpä¸ºæœ€æ–°å€¼
    return false;
}
```
å¤±è´¥æ—¶ï¼Œéƒ½ä¼šå°†headå€¼å†™å…¥expected


### ğŸ“ CAS çš„ä¸¤ä¸ªå†…å­˜åºè¯¦è§£

```cpp
compare_exchange_weak(expected, desired,
    std::memory_order_release,    // â† æˆåŠŸæ—¶çš„å†…å­˜åº
    std::memory_order_acquire);   // â† å¤±è´¥æ—¶çš„å†…å­˜åº
```

|   ç»“æœ    |         æ“ä½œ         |         å†…å­˜åºç”¨é€”         |                         å«ä¹‰                          |
| -------- | ------------------- | ------------------------- | ----------------------------------------------------- |
| **æˆåŠŸ** | `next_ptr = new_vp` | éœ€è¦**å‘å¸ƒ**æ–°å€¼ç»™å…¶ä»–çº¿ç¨‹ | æˆ‘è¦å‘å¸ƒæ•°æ®ï¼Œç¡®ä¿**ä¹‹å‰çš„å†™å…¥**å¯¹å…¶ä»–çº¿ç¨‹å¯è§          |
| **å¤±è´¥** | `old_vp = next_ptr` | éœ€è¦**è·å–**å…¶ä»–çº¿ç¨‹çš„æ–°å€¼ | CASå¤±è´¥äº†ï¼Œè¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†å€¼ï¼Œæˆ‘è¦**è·å–**æœ€æ–°æ•°æ® |


