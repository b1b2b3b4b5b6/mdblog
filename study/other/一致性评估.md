# 评测 多次回灌/实车&回灌 sensor数据一致性

# 背景

仿真，复现实车问题要要求：

 回灌&回灌，回灌&实车，给到下游感知的数据要保持相对一致

所以需要量化的方法去评估这种一致性



# 分析

对于感知来说，无论是回灌还是实车，给到自身的sensor数据在以下方面达到标准，则可以认为是相同的输入

##### 数据内容

以下回灌的数据内容应一致

- topic消息内容
- 相机nv12图
- lidar点云抽象

##### 相同数据多次回灌时的先后次序关系（全局和局部）

举例来说如果有3个数据包进行回灌（a，b，c）

- 感知在第一次回灌收到的顺序为 a<10ms>b<20ms>c
- 则感知在第二次回灌也必须按照 a<10ms>b<20ms>c 收到数据

首先，要保证数据包在两次回灌都存在，所以需考察 丢帧率

在排除丢帧影响的情况下，可以看出，实际是数据包的发送间隔决定了先后次序（间隔为负则是逆序）

所以可以通过判断两次回灌中， 按照相同的包顺序，计算得到的 发送时间间隔列表是否一致来考察

综上，可以从以下两个方面考察先后次序一致性：

- 丢帧率
- 发送时间间隔列表一致性

由于此种考察方法不区分数据类型（topic，相机，点云），所以定为 全局一致性指标

具体计算方法为：ICC



这种考察方法存在以下弊端：

- 无法得到 某种消息的一致性指标
   - 解决： 用上述相同的考察方法，去单独计算某种消息一致性指标，可以得到 局部一致性
- 无法得到 多种消息间的一致性指标
   - 解决：举例来说，如果两种消息各自局部完全一致，那么两种消息的一致性完全取决于 二者第一帧消息的发送时间间隔，如图
![](https://raw.githubusercontent.com/b1b2b3b4b5b6/pic/main/PicGo/20251226160127986.png)

两个消息各自完全一致，但是回放时，第一帧的先后不一样，分别相差a和b，导致后续每个对应帧都相差a或b

实际情况由于消息无法做到局部完全一致，所以此处计算各自消息send_diff的平均值，然后和其他消息比对，计算标准差和极差，可以得到 消息间同步平均一致性

由于两次回灌，消息发送时间存在固定的系统时间偏差，更进一步：

- 相同消息，两次回灌发送时间相减，排除系统误差后，可以得到 消息一致性波动曲线，由此可得以下指标
   - 计算标准差可得波动误差
   - 计算2分之一个消息周期，4分之一个消息周期内的波动消息占比可得 直观的一致性指标
   - 计算极差可得最差情况的波动


##### 本质

- 以回放时的系统时间为基准，评估相同的包在多次回灌情况下发送先后关系的差异
- 因为系统时间差异是稳定的，所以考察先后关系时可以排除这部分误差



# 结论

综上，共有以下指标用于评测回灌/实车sensor数据一致性
![](https://raw.githubusercontent.com/b1b2b3b4b5b6/pic/main/PicGo/20251226161051934.png)


# 工具

##### ICC

即组内相关系数，它基于变异的思想，对于两次测量如何才算一致性较好呢，很显然，如果个体内变异较小，就说明两个测量的结果一致性较好，因为如果个体内变异变大了，则说明两次测量的值差别很大，一致性不可能好。

ICC指标范围为：[-1, 1]，越大越好

我们通过经验给出阈值





