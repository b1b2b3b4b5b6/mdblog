# 像素格式

## 概述

像素格式定义了图像数据在内存中的存储方式,包括颜色空间、通道顺序和内存排布等。不同的像素格式在存储效率、处理性能和应用场景上各有特点。

## RGB 格式

### RGB888 (RGB24)

- **描述**: 每个像素使用 24 位存储,每个颜色通道 8 位
- **排布**: R-G-B-R-G-B-R-G-B...
- **字节顺序**: `[R₀][G₀][B₀][R₁][G₁][B₁]...`
- **占用大小**: 
  - 每像素: 3 字节
  - 1920×1080: 6,220,800 字节 (≈5.93 MB)
- **应用场景**: BMP 图像、屏幕显示、图像处理
- **优点**: 无损表示、处理简单
- **缺点**: 存储空间大

### BGR888 (BGR24)

- **描述**: 与 RGB888 类似,但字节顺序相反
- **排布**: B-G-R-B-G-R-B-G-R...
- **字节顺序**: `[B₀][G₀][R₀][B₁][G₁][R₁]...`
- **占用大小**: 每像素 3 字节
- **应用场景**: OpenCV 默认格式、Windows BMP

### RGBA8888 (RGBA32)

- **描述**: RGB888 + Alpha 通道
- **排布**: R-G-B-A-R-G-B-A...
- **字节顺序**: `[R₀][G₀][B₀][A₀][R₁][G₁][B₁][A₁]...`
- **占用大小**: 
  - 每像素: 4 字节
  - 1920×1080: 8,294,400 字节 (≈7.91 MB)
- **应用场景**: 需要透明度的图像处理、UI 渲染
- **Alpha 通道**: 0=完全透明, 255=完全不透明

### RGB565

- **描述**: 压缩的 RGB 格式,R 和 B 各 5 位,G 为 6 位
- **排布**: 16 位中 `RRRRR GGGGGG BBBBB`
- **字节顺序**: 小端序 `[G₂G₁G₀B₄B₃B₂B₁B₀][R₄R₃R₂R₁R₀G₅G₄G₃]`
- **占用大小**: 
  - 每像素: 2 字节
  - 1920×1080: 4,147,200 字节 (≈3.95 MB)
- **应用场景**: 嵌入式显示屏、LCD 屏幕
- **优点**: 存储空间小,G 通道多 1 位(人眼对绿色更敏感)
- **缺点**: 色彩精度损失

### RGB555

- **描述**: 每个通道 5 位,共 15 位,1 位保留
- **排布**: 16 位中 `X RRRRR GGGGG BBBBB`
- **占用大小**: 每像素 2 字节
- **应用场景**: 旧版图形系统

## YUV 格式

YUV 格式将图像分为亮度(Y)和色度(UV)分量,利用人眼对亮度更敏感的特性进行压缩。

### YUV 采样格式

- **YUV444**: 每个像素都有独立的 Y、U、V 值,无色度压缩
- **YUV422**: 水平方向 2:1 色度采样,垂直方向不压缩
- **YUV420**: 水平和垂直方向都是 2:1 色度采样

### NV12 (YUV420 Semi-Planar)

- **描述**: YUV420 格式,Y 平面存储,UV 交错存储
- **排布**: 
  ```
  Y 平面: Y₀ Y₁ Y₂ Y₃ ... (width × height 字节)
  UV 平面: U₀V₀ U₁V₁ ... (width × height / 2 字节)
  ```
- **内存布局**:
  ```
  [Y₀][Y₁][Y₂][Y₃]...[Yₙ]
  [U₀][V₀][U₁][V₁]...[Uₘ][Vₘ]
  ```
- **占用大小**: 
  - 每像素: 1.5 字节
  - 1920×1080: 3,110,400 字节 (≈2.97 MB)
  - Y 平面: width × height
  - UV 平面: width × height / 2
- **应用场景**: 视频编码(H.264/H.265)、摄像头输出、Android 系统
- **优点**: 内存访问效率高,硬件友好
- **特点**: UV 交错存储,缓存友好

### NV21

- **描述**: 与 NV12 类似,但 UV 顺序相反
- **排布**: Y 平面 + VU 交错平面
- **内存布局**:
  ```
  [Y₀][Y₁][Y₂][Y₃]...[Yₙ]
  [V₀][U₀][V₁][U₁]...[Vₘ][Uₘ]
  ```
- **占用大小**: 每像素 1.5 字节
- **应用场景**: Android Camera 默认格式

### YV12 (YUV420 Planar)

- **描述**: YUV420 格式,Y、U、V 分别存储在三个平面
- **排布**: 
  ```
  Y 平面: width × height
  U 平面: width/2 × height/2
  V 平面: width/2 × height/2
  ```
- **内存布局**:
  ```
  [Y₀][Y₁]...[Yₙ]
  [V₀][V₁]...[Vₘ]
  [U₀][U₁]...[Uₖ]
  ```
- **占用大小**: 每像素 1.5 字节
- **应用场景**: FFmpeg、视频处理
- **缺点**: 三个平面分离,内存访问不连续

### I420 (YU12)

- **描述**: 与 YV12 类似,但 U 和 V 平面顺序相反
- **排布**: Y 平面 + U 平面 + V 平面
- **占用大小**: 每像素 1.5 字节
- **应用场景**: WebRTC、视频会议

### YUYV (YUV422)

- **描述**: YUV422 打包格式,Y 每个像素都有,UV 每两个像素共享
- **排布**: Y₀-U₀-Y₁-V₀-Y₂-U₁-Y₃-V₁...
- **字节顺序**: `[Y₀][U₀][Y₁][V₀][Y₂][U₁][Y₃][V₁]...`
- **占用大小**: 
  - 每像素: 2 字节
  - 1920×1080: 4,147,200 字节 (≈3.95 MB)
- **应用场景**: USB 摄像头、视频采集卡
- **优点**: 数据连续,便于处理

### UYVY (YUV422)

- **描述**: 与 YUYV 类似,但字节顺序不同
- **排布**: U₀-Y₀-V₀-Y₁-U₁-Y₂-V₁-Y₃...
- **字节顺序**: `[U₀][Y₀][V₀][Y₁][U₁][Y₂][V₁][Y₃]...`
- **占用大小**: 每像素 2 字节
- **应用场景**: 专业视频设备

### YUV444

- **描述**: 无色度压缩的 YUV 格式
- **占用大小**: 每像素 3 字节
- **应用场景**: 高质量视频处理
- **优点**: 无色度损失

## 灰度格式

### GRAY8 (Y8)

- **描述**: 8 位灰度图像,只有亮度信息
- **排布**: Y₀-Y₁-Y₂-Y₃...
- **占用大小**: 
  - 每像素: 1 字节
  - 1920×1080: 2,073,600 字节 (≈1.98 MB)
- **应用场景**: 图像处理、机器视觉、文档扫描
- **优点**: 存储空间最小

### GRAY16

- **描述**: 16 位灰度图像
- **占用大小**: 每像素 2 字节
- **应用场景**: 医学影像、高精度图像处理

## Bayer 格式

### Bayer RGGB/BGGR/GRBG/GBRG

- **描述**: 相机传感器原始格式,每个像素只记录一种颜色
- **排布示例 (RGGB)**:
  ```
  R  G  R  G
  G  B  G  B
  R  G  R  G
  G  B  G  B
  ```
- **占用大小**: 
  - 8 位: 每像素 1 字节
  - 10 位: 每像素 1.25 字节(打包后)
  - 12 位: 每像素 1.5 字节(打包后)
- **应用场景**: 相机 RAW 格式、ISP 输入
- **处理**: 需要去马赛克(Demosaicing)算法转换为 RGB

## 压缩格式

### JPEG

- **描述**: 有损压缩格式,基于 DCT 变换
- **色彩空间**: 通常使用 YCbCr (类似 YUV)
- **占用大小**: 根据压缩质量,通常为原始大小的 5%-20%
- **应用场景**: 照片存储、网络传输

### PNG

- **描述**: 无损压缩格式,支持透明度
- **占用大小**: 根据图像内容,通常为 BMP 的 30%-60%
- **应用场景**: 网页图片、图标、需要透明度的场景

## 格式转换关系

### RGB ↔ YUV 转换公式

**RGB 转 YUV (BT.601 标准)**:
```
Y  =  0.299R + 0.587G + 0.114B
U  = -0.147R - 0.289G + 0.436B + 128
V  =  0.615R - 0.515G - 0.100B + 128
```

**YUV 转 RGB**:
```
R = Y + 1.140(V - 128)
G = Y - 0.394(U - 128) - 0.581(V - 128)
B = Y + 2.032(U - 128)
```

**BT.709 标准 (HDTV)**:
```
Y  =  0.2126R + 0.7152G + 0.0722B
U  = -0.1146R - 0.3854G + 0.5000B + 128
V  =  0.5000R - 0.4542G - 0.0458B + 128
```

## 存储空间对比表

| 格式 | 每像素字节 | 1920×1080 大小 | 相对 RGB888 |
|------|------------|----------------|-------------|
| GRAY8 | 1 | 1.98 MB | 33.3% |
| RGB565 | 2 | 3.95 MB | 66.7% |
| NV12 | 1.5 | 2.97 MB | 50% |
| NV21 | 1.5 | 2.97 MB | 50% |
| YV12 | 1.5 | 2.97 MB | 50% |
| YUYV | 2 | 3.95 MB | 66.7% |
| RGB888 | 3 | 5.93 MB | 100% |
| RGBA8888 | 4 | 7.91 MB | 133.3% |
| YUV444 | 3 | 5.93 MB | 100% |

## 选择建议

### 视频编码场景
- 优先选择 **NV12** 或 **I420**
- 硬件编码器通常支持 NV12

### 图像显示场景
- Android: **RGB565** (低端设备) 或 **RGBA8888** (高端设备)
- iOS: **BGRA8888**
- Web: **RGBA8888**

### 摄像头采集
- USB 摄像头: **YUYV** 或 **MJPEG**
- 专业相机: **Bayer RGGB/BGGR**
- 移动设备: **NV21**

### 图像处理
- OpenCV: **BGR888**
- 机器学习: **RGB888** 或 **GRAY8**
- 深度学习: 通常转换为归一化浮点数

### 存储空间受限
- **NV12/NV21** (有损色度)
- **RGB565** (有损色彩)
- **JPEG** (有损压缩)

## 性能考虑

### 内存对齐
- 大多数硬件要求行首地址对齐(如 16 字节或 32 字节)
- Stride (行跨度) 可能大于 width × bytes_per_pixel

### 缓存友好性
- **NV12** 比 **YV12** 更缓存友好(UV 交错)
- 打包格式 (YUYV) 比平面格式访问更连续

### 硬件加速
- GPU 通常原生支持: RGB888, RGBA8888, NV12
- 视频编解码器优化: NV12, I420
- ISP 输出: NV12, NV21, Bayer

## 常见库支持

### FFmpeg
- 输入: 几乎所有格式
- 输出: I420, NV12, RGB24, RGBA, YUV444 等

### OpenCV
- 原生: BGR, RGB, GRAY, YUV
- 转换: `cv::cvtColor()` 支持大多数格式互转

### GStreamer
- 支持所有主流格式
- 插件系统方便扩展

### Android
- Camera: NV21
- MediaCodec: NV12
- Bitmap: RGBA8888, RGB565

## 参考资料

- [ITU-R BT.601](https://www.itu.int/rec/R-REC-BT.601): SD 视频标准
- [ITU-R BT.709](https://www.itu.int/rec/R-REC-BT.709): HD 视频标准
- [ITU-R BT.2020](https://www.itu.int/rec/R-REC-BT.2020): UHD 视频标准
- [FourCC 代码](https://www.fourcc.org/): 视频格式标识符
