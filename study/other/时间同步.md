# 时间同步
常用的时间同步协议分为PTP和gPTP


## PTP (Precision Time Protocol)
IEEE 1588标准定义的精确时间协议，用于在局域网中同步分布式时钟

### 时钟类型
![](https://raw.githubusercontent.com/b1b2b3b4b5b6/pic/main/PicGo/20251231110827787.png)


**OC（普通时钟）**
时钟节点在同一个PTP域内只有一个PTP端口参与时间同步。
* 作为从时钟时，通过该端口与上游时钟节点同步时间。
* 作为主时钟时，只通过一个PTP端口发布时间同步信息。

**BC（边界时钟）**
时钟节点通过其中一个端口与上游时钟节点同步时间，其余端口向下游时钟节点发布时间。

**TC（透明时钟）**
* 不与其他时钟节点保持时间同步。
* TC有多个PTP端口，但只在端口间转发PTP协议报文并对其进行转发延时校正。

TC包括以下两种类型：
* E2E TC(端到端透明时钟)：直接转发网络中非P2P类型的协议报文，并参与计算整条链路的延时。
* P2P TC(点到点透明时钟)：只直接转发Sync报文、Follow_Up报文和Announce报文，而终结其它PTP协议报文，并参与计算整条链路上每一段链路的延时。

![](https://raw.githubusercontent.com/b1b2b3b4b5b6/pic/main/PicGo/20251231111343723.png)

## gPTP (generalized PTP)
IEEE 802.1AS标准定义的通用精确时间协议，是PTP在汽车以太网AVB/TSN中的应用profile
* 专为汽车以太网优化
* 仅支持二层以太网传输
* 强制使用硬件时间戳

### 支持的时钟类型
**End Station**
时间感知终端站，等同于PTP的OC
* 单个gPTP端口
* 作为时间同步的终端节点

**Bridge**
时间感知网桥，类似于PTP的BC
* 多个gPTP端口
* 一个端口从上游同步，其他端口向下游分发时间
* 强制支持P2P延迟测量

### 同步机制
#### 传输延迟测量(P2P)
![](https://raw.githubusercontent.com/b1b2b3b4b5b6/pic/main/PicGo/20251230163123964.png)
![](https://raw.githubusercontent.com/b1b2b3b4b5b6/pic/main/PicGo/20251230163301696.png)

#### 时钟偏差测量
![](https://raw.githubusercontent.com/b1b2b3b4b5b6/pic/main/PicGo/20251230162824815.png)
offset = (t2-t1) - delay

#### 频率同步
![](https://raw.githubusercontent.com/b1b2b3b4b5b6/pic/main/PicGo/20251230163216542.png)
![](https://raw.githubusercontent.com/b1b2b3b4b5b6/pic/main/PicGo/20251230163240675.png)

#### 时钟校准过程
以下图网络拓扑为例，介绍gPTP网络的时钟同步过程：
![](https://raw.githubusercontent.com/b1b2b3b4b5b6/pic/main/PicGo/20251231111945916.png)
![](https://raw.githubusercontent.com/b1b2b3b4b5b6/pic/main/PicGo/20251231112012210.png)
* 每个slave端口将周期性地发送Pdelay_Req，完成各自链路的传播延迟测量和频率同步；
* Grandmaster周期性地发送Sync报文
* 在Follow_UP报文中，PreciseOriginTimestamp字段将会填充Sycn报文离开Grandmaster的时刻t1，Correction字段添加对t1时间的修正
> 对于Grandmaster来说，Correction的数值为t1不足ns的小数部分。因为PreciseOriginTimestamp精度是ns，Correction的精度是2的（-16）次方ns

**带有bridge的同步过程**
Sync报文以主时钟为起点，经过网络扩散到每个节点，在此过程中每个节点只需关注自己和上级节点的传输延时和频率同步，Bridge负责将中间路径的传输延时和驻留时间逐级累加到Correction域，从而实现整个网络的同步, 步骤如下

* Bridge收到sync报文后，需要在一定时间内转发Sycn报文；Bridge在t2时刻收到报文，t3时刻转发报文
>注意t2/t3是bridge自身时基的度量值。
* Bridge在发送Follow_UP报文时，PreciseOriginTimestamp值不变，Correction字段值要重新计算，它的值为New Correction=Old Correction+Pdelayi+residence_time；Pdelayi为Grandmaster到Bridge的传播延迟，residence_time为Sync报文在Bridge中驻留的时间
>注意Pdelayi、residence_time都要转化为相对主时钟时基的度量值，具体计算过程请参看802.1AS标准。同时，Follow_UP报文中还包含RateRatio字段，它是主时钟频率和Bridge时钟频率的比值。
* Endpointi+1节点在t4时刻收到Sync报文，Endpointi+1节点的任意本地时刻t，对应的主时钟时间(GlobalTime(t)，即同步时间)，可以根据以下公式计算：
![](https://raw.githubusercontent.com/b1b2b3b4b5b6/pic/main/PicGo/20251231112448401.png)
* PreciseOriginTimestamp、CorrectionFieldi来自Follow_UP报文，Pdelayi+1是节点相对主时钟时基的传播延迟，RateRatioi+1主时钟频率相对本地时钟频率的比值。注意：i+1节点通过链路延迟测量和频率同步，只能计算相对Bridge时基的传播延迟和频率比，如何转化为相对主时钟时基的值，大家不妨开动一下脑筋，也可以参考802.1AS标准。




## 时间戳类型
### 单步时钟 (One-step)
* 在发送Sync/Pdelay_Resp时直接嵌入发送时间戳
* 需要硬件支持在发送时修改消息
* 无需Follow_Up消息
* 减少网络负载，提高效率

### 两步时钟 (Two-step)
* 先发送Sync/Pdelay_Resp，再通过Follow_Up传递时间戳
* 可用软件或硬件实现
* 兼容性更好
* 多一次消息交互

## PTP和gPTP异同
### 相同点
* 都基于IEEE 1588协议族
* 都采用主从时钟架构
* 都通过时间戳交互实现时钟同步
* 都支持硬件时间戳提高精度

### 不同点
| 对比项   | PTP               | gPTP           |
| :------- | :---------------- | :------------- |
| 标准     | IEEE 1588         | IEEE 802.1AS   |
| 传输层   | 支持L2/L3多种方式 | 仅支持L2以太网  |
| 延迟测量 | E2E或P2P          | 仅P2P (Pdelay) |
| 时间戳   | 可选硬件/软件     | 强制硬件时间戳  |
| 精度要求 | 微秒级            | 纳秒级          |